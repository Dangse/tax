<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상속세 과세가액 명세서</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="step1" style="display: block;">
        <div class="button-container no-print">
            <button id="addRowBtn">행 추가</button>
            <button id="printBtn">인쇄</button>
        </div>

        <div id="printContentLandscape">
            <h2>상속세 과세가액 명세서 (별지)</h2>
            <h3>가. 상속받은 총재산명세</h3>

            <table id="assetTable">
                <colgroup>
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                    <col style="width: 9%">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2">① 재산구분코드</th>
                        <th rowspan="2">② 재산종류코드</th>
                        <th colspan="3">③ 소재지ㆍ법인명 등</th>
                        <th rowspan="2">④ 사업자등록번호<br>(계좌번호,지분)</th>
                        <th rowspan="2">⑤ 수량<br>(면적)</th>
                        <th rowspan="2">⑥ 단가</th>
                        <th rowspan="2">⑦ 평가가액</th>
                        <th rowspan="2">⑧ 평가기준코드</th>
                        <th rowspan="2" class="no-print">삭제</th>
                    </tr>
                    <tr>
                        <th>국외자산<br>여부</th>
                        <th>국외재산<br>국가명</th>
                        <th style="min-width: 300px">소재지</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 행은 JavaScript로 동적 추가됨 -->
                </tbody>
                <tfoot>
                    <tr id="totalRow">
                        <td colspan="6">계</td>
                        <td></td>
                        <td></td>
                        <td id="grandTotal">0</td>
                        <td></td>
                        <td class="no-print"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <button id="nextBtn">다음</button>
    </div>

    <div id="step2" style="display: none;">
        <h2>2단계 입니다</h2>
        <button id="nextBtn2">다음</button>
        <button id="prevBtn1">뒤로가기</button>
    </div>

    <div id="step3" style="display: none;">
        <h2>3단계 입니다</h2>
        <button id="prevBtn2">뒤로가기</button>
    </div>

    <!-- 팝업들 -->
    <div id="assetTypePopup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>자산 유형 선택</h3>
            <div id="assetTypeContent"></div>
        </div>
    </div>

    <div id="propertyTypePopup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>재산 종류 선택</h3>
            <div id="propertyTypeContent"></div>
        </div>
    </div>

    <div id="evaluationStandardPopup" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <h3>평가 기준 선택</h3>
            <div id="evaluationStandardContent"></div>
        </div>
    </div>

    <!-- 도움말 팝업들 -->
    <div id="helpPopup1" class="popup-overlay">
        <div class="popup-content">
            <h3>재산구분 코드 설명</h3>
            <p>상속인이 상속재산을 받은 경우 : A11</p>
            <p>상속인이 아닌자. 자녀가 살아있는데, 손자 손녀 또는 사위, 타인에게 유언으로 상속하는 경우 : A12</p>
            <p><strong>동영상보기 !! :</strong></p>
            <button onclick="closeHelpPopup('helpPopup1')">닫기</button>
        </div>
    </div>

    <div id="helpPopup2" class="popup-overlay">
        <div class="popup-content">
            <h3>재산 종류 코드 설명</h3>
            <p><strong>동영상보기!!! :</strong></p>
            <button onclick="closeHelpPopup('helpPopup2')">닫기</button>
        </div>
    </div>

    <div id="helpPopup3" class="popup-overlay">
        <div class="popup-content">
            <h3>평가기준코드</h3>
            <p><strong>동영상보기 !!! :</strong></p>
            <button onclick="closeHelpPopup('helpPopup3')">닫기</button>
        </div>
    </div>

<script >
// 상수 및 데이터
const ASSET_TYPES = {
    'A11': '상속인이 상속재산을 받은 경우',
    'A12': '상속인이 아닌 자가 상속받은 경우'
};

const PROPERTY_TYPES = {
    '11': '토지',
    '12': '건물',
    '13': '부동산에 관한 권리',
    '21': '현금',
    '22': '예금'
    // 추가 재산 종류...
};

const EVALUATION_STANDARDS = {
    '1': '시가',
    '2': '공시지가',
    '3': '감정가액'
    // 추가 평가 기준...
};

// DOM 요소
const assetTable = document.getElementById('assetTable');
const addRowBtn = document.getElementById('addRowBtn');
const printBtn = document.getElementById('printBtn');
const nextBtn = document.getElementById('nextBtn');
const prevBtn1 = document.getElementById('prevBtn1');
const prevBtn2 = document.getElementById('prevBtn2');

// 이벤트 리스너
document.addEventListener('DOMContentLoaded', initializeTable);
addRowBtn.addEventListener('click', addRow);
printBtn.addEventListener('click', printPage);
nextBtn.addEventListener('click', () => showStep(2));
prevBtn1.addEventListener('click', () => showStep(1));
nextBtn2.addEventListener('click', () => showStep(3));
prevBtn2.addEventListener('click', () => showStep(2));

assetTable.addEventListener('click', handleTableClick);
assetTable.addEventListener('input', handleTableInput);

// 함수들
function initializeTable() {
    addRow(); // 초기 행 하나 추가
    updateGrandTotal();
}

function addRow() {
    const tbody = assetTable.querySelector('tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td><span class="selector" data-type="assetType">선택</span></td>
        <td><span class="selector" data-type="propertyType">선택</span></td>
        <td><input type="checkbox" name="foreignAsset"></td>
        <td><input type="text" name="country"></td>
        <td><input type="text" name="location"></td>
        <td><input type="text" name="businessNumber"></td>
        <td><input type="number" name="quantity"></td>
        <td><input type="number" name="price"></td>
        <td class="total">0</td>
        <td><span class="selector" data-type="evaluationStandard">선택</span></td>
        <td class="no-print"><button onclick="deleteRow(this)">삭제</button></td>
    `;
    tbody.appendChild(newRow);
}

function deleteRow(button) {
    button.closest('tr').remove();
    updateGrandTotal();
}

function handleTableClick(event) {
    if (event.target.classList.contains('selector')) {
        openPopup(event.target.dataset.type, event.target);
    }
}

function handleTableInput(event) {
    if (event.target.matches('input[type="number"]')) {
        calculateRowTotal(event.target.closest('tr'));
        updateGrandTotal();
    }
}

function openPopup(type, selectorElement) {
    const popup = document.getElementById(`${type}Popup`);
    const content = popup.querySelector('.popup-content div');
    content.innerHTML = '';

    let options;
    switch(type) {
        case 'assetType': options = ASSET_TYPES; break;
        case 'propertyType': options = PROPERTY_TYPES; break;
        case 'evaluationStandard': options = EVALUATION_STANDARDS; break;
    }

    for (const [code, description] of Object.entries(options)) {
        const option = document.createElement('div');
        option.textContent = `${code}: ${description}`;
        option.addEventListener('click', () => selectOption(type, code, selectorElement));
        content.appendChild(option);
    }

    popup.style.display = 'block';
}

function selectOption(type, code, selectorElement) {
    selectorElement.textContent = code;
    selectorElement.dataset.selected = code;
    closePopup(`${type}Popup`);
    calculateRowTotal(selectorElement.closest('tr'));
    updateGrandTotal();
}

function closePopup(popupId) {
    document.getElementById(popupId).style.display = 'none';
}

function calculateRowTotal(row) {
    const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
    const assetType = row.querySelector('span[data-type="assetType"]').dataset.selected;
    const propertyType = row.querySelector('span[data-type="propertyType"]').dataset.selected;
    const evaluationStandard = row.querySelector('span[data-type="evaluationStandard"]').dataset.selected;

    let total = quantity * price;

    // 여기에 재산 유형, 평가 기준 등에 따른 추가 계산 로직 구현
    // 예: if (propertyType === '11' && evaluationStandard === '2') { total *= 0.9; }

    row.querySelector('.total').textContent = total.toLocaleString('ko-KR');
}

function updateGrandTotal() {
    const totalCells = assetTable.querySelectorAll('tbody .total');
    let grandTotal = 0;

    totalCells.forEach(cell => {
        grandTotal += parseFloat(cell.textContent.replace(/,/g, '')) || 0;
    });

    document.getElementById('grandTotal').textContent = grandTotal
    document.getElementById('grandTotal').textContent = grandTotal.toLocaleString('ko-KR');
}

function printPage() {
    window.print();
}

function showStep(stepNumber) {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    document.getElementById(`step${stepNumber}`).style.display = 'block';
}

// 도움말 팝업 관련 함수
function showHelpPopup(popupId) {
    document.getElementById(popupId).style.display = 'block';
}

function closeHelpPopup(popupId) {
    document.getElementById(popupId).style.display = 'none';
}

// 도움말 버튼에 이벤트 리스너 추가
document.querySelectorAll('.help-button').forEach(button => {
    button.addEventListener('click', () => showHelpPopup(button.dataset.popup));
});

// 팝업 닫기 버튼에 이벤트 리스너 추가
document.querySelectorAll('.popup .close').forEach(closeButton => {
    closeButton.addEventListener('click', () => {
        closeButton.closest('.popup').style.display = 'none';
    });
});

// 윈도우 클릭 시 팝업 닫기
window.addEventListener('click', (event) => {
    if (event.target.classList.contains('popup')) {
        event.target.style.display = 'none';
    }
});

// 초기화 함수 호출
initializeTable();
    
</script>
</body>
</html>